'use strict';

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

var _fs = require('fs');

var _fs2 = _interopRequireDefault(_fs);

var _mime = require('mime');

var _mime2 = _interopRequireDefault(_mime);

require('./_payload.js');

/**
 * output file
 * @param  {Object} http    []
 * @param  {String} file [file path]
 * @return {}         []
 */
think.middleware('output_resource', function (http, file) {
  //not resource
  if (file === false) {
    return;
  }
  //is resource but not exist
  if (file === true) {
    http.status(404);
    http.end();
    return think.prevent();
  }
  //flag request is resource
  http._isResource = true;

  var contentType = _mime2['default'].lookup(file);
  http.type(contentType, false);

  var range = http.header('range');
  if (!range) {
    var stream = _fs2['default'].createReadStream(file);
    stream.pipe(http.res);
    stream.on('end', function () {
      http.end();
    });
    stream.on('error', function () {
      http.end();
    });
    return think.prevent();
  }

  //request has range header
  var size = _fs2['default'].statSync(file).size;
  var match = range.match(/bytes=(\d+)\-(\d*)/);
  var slice = 1 * 1024 * 1024;
  var from = parseInt(match[1]) || 0;
  var to = parseInt(match[2]) || 0;
  if (!to) {
    to = from + slice - 1;
  }
  to = Math.min(to, size - 1);

  http.status(206);
  http.header('Accept-Ranges', 'bytes');
  http.header('Content-Range', 'bytes ' + from + '-' + to + '/' + size);

  var fd = _fs2['default'].openSync(file, 'r');
  var buffer = new Buffer(to - from + 1);
  _fs2['default'].readSync(fd, buffer, 0, to - from, from);
  _fs2['default'].closeSync(fd);
  http.end(buffer);

  return think.prevent();
});

/**
 * rewrite pathname, remove prefix & suffix
 * @param  {Object} http
 * @return {}         []
 */
think.middleware('rewrite_pathname', function (http) {
  var pathname = http.pathname;
  if (!pathname) {
    return;
  }
  var prefix = http.config('pathname_prefix');
  if (prefix && pathname.indexOf(prefix) === 0) {
    pathname = pathname.substr(prefix.length);
  }
  var suffix = http.config('pathname_suffix');
  if (suffix && pathname.substr(0 - suffix.length) === suffix) {
    pathname = pathname.substr(0, pathname.length - suffix.length);
  }
  http.pathname = pathname;
});

/**
 * sub domain deploy
 * @param  {Object} http){}
 * @return {}
 */
think.middleware('subdomain_deploy', function (http) {
  var subdomain = http.config('subdomain');
  if (think.isEmpty(subdomain)) {
    return;
  }
  var hostname = http.hostname.split('.')[0];
  var value = subdomain[hostname];
  if (!value) {
    return;
  }
  http.pathname = value + '/' + http.pathname;
});